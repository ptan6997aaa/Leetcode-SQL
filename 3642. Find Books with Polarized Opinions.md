```md
3642. Find Books with Polarized Opinions
Table: books

+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| book_id     | int     |
| title       | varchar |
| author      | varchar |
| genre       | varchar |
| pages       | int     |
+-------------+---------+
book_id is the unique ID for this table.
Each row contains information about a book including its genre and page count.
Table: reading_sessions

+----------------+---------+
| Column Name    | Type    |
+----------------+---------+
| session_id     | int     |
| book_id        | int     |
| reader_name    | varchar |
| pages_read     | int     |
| session_rating | int     |
+----------------+---------+
session_id is the unique ID for this table.
Each row represents a reading session where someone read a portion of a book. session_rating is on a scale of 1-5.
Write a solution to find books that have polarized opinions - books that receive both very high ratings and very low ratings from different readers.

A book has polarized opinions if it has at least one rating ≥ 4 and at least one rating ≤ 2
Only consider books that have at least 5 reading sessions
Calculate the rating spread as (highest_rating - lowest_rating)
Calculate the polarization score as the number of extreme ratings (ratings ≤ 2 or ≥ 4) divided by total sessions
Only include books where polarization score ≥ 0.6 (at least 60% extreme ratings)
Return the result table ordered by polarization score in descending order, then by title in descending order.

The result format is in the following example.

 

Example:

Input:

books table:

+---------+------------------------+---------------+----------+-------+
| book_id | title                  | author        | genre    | pages |
+---------+------------------------+---------------+----------+-------+
| 1       | The Great Gatsby       | F. Scott      | Fiction  | 180   |
| 2       | To Kill a Mockingbird  | Harper Lee    | Fiction  | 281   |
| 3       | 1984                   | George Orwell | Dystopian| 328   |
| 4       | Pride and Prejudice    | Jane Austen   | Romance  | 432   |
| 5       | The Catcher in the Rye | J.D. Salinger | Fiction  | 277   |
+---------+------------------------+---------------+----------+-------+
reading_sessions table:

+------------+---------+-------------+------------+----------------+
| session_id | book_id | reader_name | pages_read | session_rating |
+------------+---------+-------------+------------+----------------+
| 1          | 1       | Alice       | 50         | 5              |
| 2          | 1       | Bob         | 60         | 1              |
| 3          | 1       | Carol       | 40         | 4              |
| 4          | 1       | David       | 30         | 2              |
| 5          | 1       | Emma        | 45         | 5              |
| 6          | 2       | Frank       | 80         | 4              |
| 7          | 2       | Grace       | 70         | 4              |
| 8          | 2       | Henry       | 90         | 5              |
| 9          | 2       | Ivy         | 60         | 4              |
| 10         | 2       | Jack        | 75         | 4              |
| 11         | 3       | Kate        | 100        | 2              |
| 12         | 3       | Liam        | 120        | 1              |
| 13         | 3       | Mia         | 80         | 2              |
| 14         | 3       | Noah        | 90         | 1              |
| 15         | 3       | Olivia      | 110        | 4              |
| 16         | 3       | Paul        | 95         | 5              |
| 17         | 4       | Quinn       | 150        | 3              |
| 18         | 4       | Ruby        | 140        | 3              |
| 19         | 5       | Sam         | 80         | 1              |
| 20         | 5       | Tara        | 70         | 2              |
+------------+---------+-------------+------------+----------------+
Output:

+---------+------------------+---------------+-----------+-------+---------------+--------------------+
| book_id | title            | author        | genre     | pages | rating_spread | polarization_score |
+---------+------------------+---------------+-----------+-------+---------------+--------------------+
| 1       | The Great Gatsby | F. Scott      | Fiction   | 180   | 4             | 1.00               |
| 3       | 1984             | George Orwell | Dystopian | 328   | 4             | 1.00               |
+---------+------------------+---------------+-----------+-------+---------------+--------------------+
Explanation:

The Great Gatsby (book_id = 1):
Has 5 reading sessions (meets minimum requirement)
Ratings: 5, 1, 4, 2, 5
Has ratings ≥ 4: 5, 4, 5 (3 sessions)
Has ratings ≤ 2: 1, 2 (2 sessions)
Rating spread: 5 - 1 = 4
Extreme ratings (≤2 or ≥4): All 5 sessions (5, 1, 4, 2, 5)
Polarization score: 5/5 = 1.00 (≥ 0.6, qualifies)
1984 (book_id = 3):
Has 6 reading sessions (meets minimum requirement)
Ratings: 2, 1, 2, 1, 4, 5
Has ratings ≥ 4: 4, 5 (2 sessions)
Has ratings ≤ 2: 2, 1, 2, 1 (4 sessions)
Rating spread: 5 - 1 = 4
Extreme ratings (≤2 or ≥4): All 6 sessions (2, 1, 2, 1, 4, 5)
Polarization score: 6/6 = 1.00 (≥ 0.6, qualifies)
Books not included:
To Kill a Mockingbird (book_id = 2): All ratings are 4-5, no low ratings (≤2)
Pride and Prejudice (book_id = 4): Only 2 sessions (< 5 minimum)
The Catcher in the Rye (book_id = 5): Only 2 sessions (< 5 minimum)
The result table is ordered by polarization score in descending order, then by book title in descending order
```

```sql
# Write your MySQL query statement below
WITH check_beyound_four AS (
    SELECT book_id, 
            (CASE 
                WHEN session_rating >= 4 THEN 1 
                ELSE 0 
            END) AS check_beyound_four 
    FROM reading_sessions     
), 
count_beyound_four AS (
    SELECT book_id, SUM(check_beyound_four) AS total_beyound_four    
    FROM check_beyound_four 
    GROUP BY book_id 
    HAVING total_beyound_four >= 1   
), 
check_within_two AS (
    SELECT book_id, 
            (CASE 
                WHEN session_rating <= 2 THEN 1 
                ELSE 0 
            END) AS check_within_two 
    FROM reading_sessions     
), 
count_within_two AS (
    SELECT book_id, SUM(check_within_two) AS total_within_two    
    FROM check_within_two 
    GROUP BY book_id 
    HAVING total_within_two >= 1   
), 
has_polarized_opinions AS (
    SELECT count_beyound_four.book_id, total_beyound_four, total_within_two  
    FROM count_beyound_four 
    INNER JOIN count_within_two 
    ON count_beyound_four.book_id = count_within_two.book_id     
), 
count_reading_session AS (
    SELECT book_id, COUNT(session_rating) AS count_session     
    FROM reading_sessions 
    GROUP BY book_id 
    HAVING count_session >= 5     
), 
join_table_one AS (
    SELECT has_polarized_opinions.book_id 
    FROM has_polarized_opinions 
    INNER JOIN count_reading_session 
    ON has_polarized_opinions.book_id = count_reading_session.book_id    
), 
rating_spread AS (
    SELECT book_id, MAX(session_rating) - MIN(session_rating) AS rating_spread   
    FROM reading_sessions  
    GROUP BY book_id  
),
join_table_two AS (
    SELECT join_table_one.book_id, rating_spread  
    FROM join_table_one 
    INNER JOIN rating_spread 
    ON join_table_one.book_id = rating_spread.book_id    
), 
total_session AS (
    SELECT book_id, COUNT(*) AS total_session 
    FROM reading_sessions 
    GROUP BY book_id   
), 
prep_polarization_score_table AS (
    SELECT has_polarized_opinions.*, total_session
    FROM has_polarized_opinions 
    INNER JOIN total_session 
    ON has_polarized_opinions.book_id = total_session.book_id     
),
count_polarization_score AS (
    SELECT book_id, ROUND((total_beyound_four + total_within_two) / total_session, 2) AS polarization_score    
    FROM prep_polarization_score_table     
), 
filter_polarization_score AS (
    SELECT * 
    FROM count_polarization_score 
    WHERE polarization_score >= 0.6   
),
join_table_three AS (
    SELECT join_table_two.*, filter_polarization_score.polarization_score   
    FROM join_table_two 
    INNER JOIN filter_polarization_score 
    ON join_table_two.book_id = filter_polarization_score.book_id        
) 
SELECT books.*, rating_spread, polarization_score  
FROM join_table_three 
INNER JOIN books 
ON  join_table_three.book_id = books.book_id 
ORDER BY polarization_score DESC, title DESC             
```
